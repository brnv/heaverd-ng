# Maintainer: Alexey Baranov <a.baranov@office.ngs.ru>

pkgname=heaverd-ng
pkgver=29dd8f
pkgrel=1
pkgdesc="Balancer and restapi frontend for heaver"
arch=('x86_64')
url="http://git.rn/projects/DEVOPS/repos/heaverd-ng/"
license=('unknown')
depends=('etcd')
install='install.sh'
backup=('etc/heaverd-ng/heaverd-ng.conf.toml')
md5sums=() #generate with 'makepkg -g'
branch="dev"

pkgver() {
	cd $srcdir
	VERSION=`git show-ref | grep $branch | head -n1 | cut -c 1-6`
	printf $VERSION
}

prepare() {
	rm -rf $srcdir/*
	rm -rf $srcdir/.git
	rm -f $GOPATH/src/heaverd-ng
}

build() {
	sudo -ua.baranov git clone ssh://git@git.rn/devops/heaverd-ng.git $srcdir
	ln -s $srcdir $GOPATH/src/heaverd-ng
	cd $srcdir
	git checkout $branch
	go build main.go
}

package() {
	mkdir -p $pkgdir/usr/bin/
	mkdir -p $pkgdir/usr/share/heaverd-ng
	mkdir -p $pkgdir/etc/heaverd-ng/
	mkdir -p $pkgdir/usr/lib/systemd/system/

	cp $srcdir/main $pkgdir/usr/bin/heaverd-ng
	cp $srcdir/pkg/config/heaverd-ng.conf.toml $pkgdir/etc/heaverd-ng/
	cp -r $srcdir/www/templates $pkgdir/usr/share/heaverd-ng/
	cp -r $srcdir/www/static $pkgdir/usr/share/heaverd-ng/

	cp $srcdir/pkg/systemd/heaverd-ng.service $pkgdir/usr/lib/systemd/system/
}
